---
title: "My title"
subtitle: "My subtitle if needed"
author: Ahnaf Alam
thanks: "Code and data are available at: LINK."
date: today
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
format: pdf
number-sections: true
bibliography: references.bib
toc: true
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(ggplot2)
library(rstanarm)
library(kableExtra)
library(viridis)
library(testthat)
library(fredr)


data <- read_csv(here::here("data/analysis_data/data.csv"))

```


# Introduction

You can and should cross-reference sections and sub-sections. We use @citeR and @rohan.

The remainder of this paper is structured as follows. @sec-data....






# Data {#sec-data}

## Software and R-packages

We create this project using statistical software, `R` [@citeR]. For cleaning and re-purposing the data, we used `tidyverse` [@tidy] package and graphs, we relied on `ggplot2` [@ggplot2]. The data used in this paper comes from [@fredr] package. We further used `rstanarm` [@rstanarm] for modelling. Lastly, we used `kableExtra` [@kable] and `viridis` [@viridis] for aesthetics purposes.

## Incorporating FRED data 

The data comes from FRED or Federal Reserve Economic Data, which is an online database, consisting of hundreds of thousands time series economic data on both US national level and international level. From the database, we incorporated six different datasets using `fredr` package. These were titled:

- Real personal consumption expenditure: Food
- Real disposable personal income
- Real personal consumption expenditure: Durable Goods
- Real personal consumption expenditure: Nondurable Goods
- Real personal consumption expenditure: Services
- Real personal consumption expenditure: Healthcare

A detailed description of what each of these datasets reports on can be found on @tbl-1.  There are few key features that are present in all of the datasets. Firstly, we only incorporate data between 2007 and 2022 on a quarterly basis. We used as an 2007 as an anchor because data on durable/nondurable goods is only available from year and we wanted to model our data on 15 year period, hence 2022. 

All the datasets are also seasonally adjusted and chained to 2017 dollars. Seasonally adjusted time series eliminates effect of seasonal influences. Seasonal influences like strikes, abnormal weather patterns, or events Boxing day sale, can distort the real underlying movements in the business cycle and adjusting for these variation, provides us with much clearer understanding of the dataset from period to period. The datasets used 2017 price level as reference point. This adjusts for inflation across time, allowing us to accurately compare economic data over multiple periods. We further adjust for inflation by using real economic data, as opposed to nominal data. This enables us to create valid comparison groups, allowing us to compare a category with another category across time.

## Dataset characteristics

Each dataset contains five different columns, with key ones being date and value. The data variable reports on the specific day on which data was collected. With quarterly data, we only see data on the first day from the months of January, April, August and October. Although quarterly, FRED does not include data for quarter months of August, or indeed December. This is more due to convenience as some data becomes available only after end of the quarter and updating the database on before that is not productive. Lastly, value columns reports on expenditure in billions of US dollars. For a better understanding of how each category measure up against one another, please see @fig-2. @tbl-2 reports in cleaned data that is being used for modelling and analysis. 


## Measurement

FRED does not collect data itself but relies on public and private organizations to provide the database with data. Except for first and last observations of the month, FRED ignores missing value when it average, sum and end-of-period aggregation [@fred]. In this context, missing values often arise during statutory holidays, when federal offices are closed. On those weeks, FRED only reports data on 6 days of the week, excluding the holiday and end-of-period calculation will be conducted based whatever the corresponding days are in that month, minus one. 





```{r}
#| label: fig-1
#| fig-cap: Levels of real consumption expenditure and income expenditure, in billions of dollars, chained to 2017 prices
#| fig-subcap: ["Food expenditure", "Income"]
#| echo: false
#| warning: false
#| message: false
#| layout-ncol: 2
    
data |>
  ggplot(aes(x = date, y = food_expenditure)) +
  geom_line() +
  theme_minimal() +
  labs(x = "Date",
       y = "Real food expenditure",
       )

data |>
  ggplot(aes(x = date, y =income_expenditure)) +
  geom_line() +
  theme_minimal() +
  labs(x = "Date",
       y = "Real disposable income",
       )
```



```{r}
#| label: tbl-1
#| tbl-cap: "Description of the data variables"
#| warning: false
#| message: false
#| echo: false


table1 <-
  tibble(
    "Expenditure variable"= c("Date", "Durable goods", "Non-durable goods", "Food", "Disposable income",
                      "Healthcare", "Services"),
    "Description" = c("Date of data collected",
                      "Durable goods are goods that are more for future consumption than immediate consumption. These types
                      of goods provides utlity over a length of period. Examples include machinery, tools, appliances
                      among others",
                      "Durable goods are anything that are generally consumed within a short period of time. Examples
                      include food, clothing, cosmetics etc",
                      "Expenditure in food by all Americans in a time period",
                      "Refers to total income that is availble to individuals for consumption after deducing taxes",
                      "The category reports on total expenditure on healthcare services, including medical treatments,
                      medicine cost, physician services among other services",
                      "This category encomapasses a variety of services, inluding education, transportation,
                      utilities, hospitality and many others")
  )

table1 %>%
  kable("latex", booktabs = TRUE) %>%
  column_spec(1, width = "2cm") %>%
  column_spec(2, width = "14cm") %>%
  kable_styling(latex_options = "hold_position", font_size = 9, position = "center")

```


```{r}
#| label: fig-2
#| fig-cap: Expenditure for different categories, in billions of 2017 dollars
#| echo: false
#| warning: false
#| message: false


data$date <- as.Date(data$date)


data_long <- reshape2::melt(data, id.vars = "date")

newnames <- c("durable_expenditure" = "Durable goods",
              "nondurable_expenditure" = "Nondurable goods",
              "food_expenditure" = "Food",
              "income_expenditure" = "Disposable income",
              "healthcare_expenditure" = "Healthcare",
              "services_expenditure" = "Services")

col <- viridis(6)

figure <- data_long |>
  ggplot( aes(x = date, y = value, fill = variable)) +
  geom_area() +
  labs(title = "Contribution of Expenditure Categories Over Time",
       x = "Date",
       y = "Expenditure",
       fill = "Categories") +
  theme_minimal() +
  scale_fill_manual(values = col, labels = newnames, name = "Categories")
print(figure)

```




```{r}
#| echo: false
#| warning: false
#| label: tbl-2
#| tbl-cap: "Cleaned data showing real expenditure by different categories"

columns_to_format <- names(data)[-1]

formatted_data <- data
formatted_data[columns_to_format] <- lapply(data[columns_to_format], function(x) sprintf("%.2f", x))


formatted_data[1:12,] |> 
  kable(col.names = c("Date", "Durable goods", "Non-durable goods", "Food", "Disposable income",
                      "Healthcare", "Services"),
        booktabs = TRUE,
        linesep = "",
        align = "c",
        format.args = list(big.mark = ",")
        ) |>
  column_spec(c(1, 2, 3, 4, 5, 6, 7), width = "6em") |> 
  kable_styling(font_size = 9, latex_options = "scale_down") 
```





```{r}
#| label: fig-3
#| fig-cap: Relationship between increases in disposable income and increases in food expenditure, between 2007 and 2022.
#| echo: false
#| warning: false
#| message: false

data |>
  ggplot(aes(x = income_expenditure, y = food_expenditure)) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = "lm",
    se = TRUE,
    color = "black",
    linetype = "dashed",
    formula = y ~ x
  ) +
  theme_classic() + 
  labs(
    x = "Real increase in disposable income",
    y = "Real increase in food expenditure"
  )
```

 



# Model


```{r}
#| echo: false
#| warning: false
#| message: false
#| label: tbl-3
#| tbl-cap: Summary results for both models


first_model <- 
  readRDS(file = here::here("models/model_1.rds"))

second_model <- 
  readRDS(file = here::here("models/model_2.rds"))

modelsummary::modelsummary(
  list(
    "Simple linear" = first_model,
    "Multiple linear" = second_model
  ),
  statistic = "mad",
  fmt = 2
)
```


The goal of our modelling strategy is twofold. Firstly,...

Here we briefly describe the Bayesian analysis model used to investigate... Background details and diagnostics are included in [Appendix -@sec-model-details].

## Model set-up

Define $y_i$ as the number of seconds that the plane remained aloft. Then $\beta_i$ is the wing width and $\gamma_i$ is the wing length, both measured in millimeters.  

\begin{align} 
y_i|\mu_i, \sigma &\sim \mbox{Normal}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta_i + \gamma_i\\
\alpha &\sim \mbox{Normal}(0, 2.5) \\
\beta &\sim \mbox{Normal}(0, 2.5) \\
\gamma &\sim \mbox{Normal}(0, 2.5) \\
\sigma &\sim \mbox{Exponential}(1)
\end{align}

We run the model in R [@citeR] using the `rstanarm` package of @rstanarm. We use the default priors from `rstanarm`.


### Model justification

We expect a positive relationship between the size of the wings and time spent aloft. In particular...

We can use maths by including latex between dollar signs, for instance $\theta$.


# Results

Our results are summarized in @tbl-modelresults.








# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {-}

We are at the back end of covid-19 pandemic yet risks of another widespread epidemic is still rather underestimated. At the beginning of this pandemic, public health officials were rather caught off-guard with the emergence and virulence of this disease. As such, public were relayed lots of mixed messages regarding what they can do to mitigate the risk of infection and this confusion only added to public panic. Measures like Spain banning smoking in public were, or mandatory gloves Russia and Ukraine  were implemented, which may sound absurd right now, although at the time seemed reasonable. However, public health experts soon realized effectiveness of masks in slowing transmission rate. A meta-analysis, consisting of 6 studies from 4 different countries show that masks significantly reduce transmission risks (OR = 0.38, 95% CI: 0.21-0.69, I2 = 54.1%)  , and among health care workers, masks reduce transmission by as much as 70%. 



# Additional data details

# Model details {#sec-model-details}






## Posterior predictive check

In @fig-ppcheckandposteriorvsprior-1 we implement a posterior predictive check. This shows...

In @fig-ppcheckandposteriorvsprior-2 we compare the posterior with the prior. This shows... 

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-4
#| layout-ncol: 2
#| fig-cap: "Examining how the model fits, and is affected by, the data"
#| fig-subcap: ["Posterior prediction check of simple linear regression", "Posterior prediction check of multiple linear regression"]


pp_check(first_model) +
  theme_classic() +
  theme(legend.position = "bottom")

pp_check(second_model) +
  theme_classic() +
  theme(legend.position = "bottom")

```






## Diagnostics

@fig-stanareyouokay-1 is a trace plot. It shows... This suggests...

@fig-stanareyouokay-2 is a Rhat plot. It shows... This suggests...

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-5
#| fig-cap: "Checking the convergence of the MCMC algorithm"
#| fig-subcap: ["Trace plot of Model 1", "Trace plot of model 2"]
#| layout-ncol: 2

plot(first_model, "trace")

plot(second_model, "trace")



```



\newpage


# References


